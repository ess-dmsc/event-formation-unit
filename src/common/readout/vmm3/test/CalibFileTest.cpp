// Copyright (C) 2021 European Spallation Source, ERIC. See LICENSE file
//===----------------------------------------------------------------------===//
///
/// \file
///
/// \brief Unit tests for loading calibration files and applying
/// calibration parameters to the VMMs in a Hybrid
//===----------------------------------------------------------------------===//

#include <common/readout/vmm3/CalibFile.h>
#include <common/readout/vmm3/Hybrid.h>
#include <common/testutils/TestBase.h>


auto j2 = R"(
  {
    "Detector" : "Freia",
    "Version"  : 1,
    "Hybrids" : 1,

    "Calibrations" : [
      { "VMMHybridCalibration" : {
          "HybridIndex" : 0,
          "HybridId" : "ff7245e2d61cfcce2feafd7e687cdb0e",
          "CalibrationDate" : "20210222-124533",

          "vmm0" : {
            "adc_offset" : [4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892],
            "adc_slope"  : [1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171],
            "tdc_offset" : [4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892],
            "tdc_slope"  : [1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171],
            "tdc_ofs_corr" : [0.0, 1.0]
          },
          "vmm1" : {
            "adc_offset" : [4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892],
            "adc_slope"  : [1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171],
            "tdc_offset" : [4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892, 4.336, 2.689, 1.315, 3.892],
            "tdc_slope"  : [1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171, 1.16,  1.164, 1.173, 1.171],
            "tdc_ofs_corr" : [0.0, 1.0]
          }
        }
      }
    ]
  }
)"_json;


class CalibFileTest : public TestBase {
protected:
  std::vector<ESSReadout::Hybrid> hybrids{1};
  nlohmann::json j;
};


TEST_F(CalibFileTest, Constructor) {
  ESSReadout::CalibFile MyCalibFile("Freia", hybrids);
}


TEST_F(CalibFileTest, NoFile) {
  ESSReadout::CalibFile MyCalibFile("Freia", hybrids);
  EXPECT_ANY_THROW(MyCalibFile.load("nosuchfile"));
}

TEST_F(CalibFileTest, EmptyJson) {
  ESSReadout::CalibFile MyCalibFile("Freia", hybrids);
  MyCalibFile.root = j;
  EXPECT_ANY_THROW(MyCalibFile.apply());
}

TEST_F(CalibFileTest, OneHybrid) {
  ASSERT_EQ(hybrids[0].HybridId.size(), 0);
  ESSReadout::CalibFile MyCalibFile("Freia", hybrids);
  MyCalibFile.root = j2;
  MyCalibFile.apply();
  ASSERT_EQ(hybrids[0].HybridId.size(), 32);
}


int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
