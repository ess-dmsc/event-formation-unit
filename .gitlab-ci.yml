workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

default:
  tags:
    - docker
  
stages:
  - setup
  - cppcheck
  - build
  - test
  - publish

variables:
  ALMALINUX9_IMAGE: "registry.esss.lu.se/ecdc/ess-dmsc/docker-almalinux9-conan:1.3.0"
  CENTOS7_IMAGE: "registry.esss.lu.se/ecdc/ess-dmsc/docker-centos7-conan:1.1.0"
  UBUNTU2204_IMAGE: "registry.esss.lu.se/ecdc/ess-dmsc/docker-ubuntu2204-conan:1.1.0"
  CONAN_USER_HOME: "$CI_PROJECT_DIR"

conan_setup:
  stage: setup
  image: $ALMALINUX9_IMAGE
  script:
    - conan config install http://github.com/ess-dmsc/conan-configuration.git
  artifacts:
    paths:
      - .conan/
    expire_in: 1 hour
    when: always

cppcheck:
  stage: cppcheck
  image: $ALMALINUX9_IMAGE
  script:
    - find src/ -type f \( -name '*.cpp' -o -name '*.c' -o -name '*.h' \) '!' -path "*/test/*" '!' -name "*Test*" > cppcheck_files.txt
    - cppcheck --enable=all --inconclusive --std=c++14 --suppress=missingIncludeSystem --file-list=cppcheck_files.txt 2> cppcheck.xml
  artifacts:
    reports:
      codequality: cppcheck.xml
    paths:
      - cppcheck.xml
    expire_in: 1 week

almalinux9_gcc11_release:
  image: $ALMALINUX9_IMAGE
  stage: build
  dependencies:
    - conan_setup
  artifacts:
    paths:
      - build/
    expire_in: 1 day
  script:
    - mkdir -p build
    - cd build
    - conan install .. --build=missing --profile=linux_x86_64_gcc11
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - make -j$(nproc) all

ubuntu2204_gcc11_release:
  image: $UBUNTU2204_IMAGE
  stage: build
  dependencies:
    - conan_setup
  artifacts:
    paths:
      - build/
    expire_in: 1 day
  script:
    - mkdir -p build
    - cd build
    - conan install .. --build=missing --profile=linux_x86_64_gcc11
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - make -j$(nproc) all

ubuntu2204_clang17_release:
  image: $UBUNTU2204_IMAGE
  stage: build
  dependencies:
    - conan_setup
  artifacts:
    paths:
      - build/
    expire_in: 1 day
  variables:
    CC: /usr/bin/clang-17
    CXX: /usr/bin/clang++-17
  script:
    - mkdir -p build
    - cd build
    - conan install .. --build=missing --profile=linux_x86_64_clang17
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - make -j$(nproc) all
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

centos7_gcc11_release:
  image: $CENTOS7_IMAGE
  stage: build
  dependencies:
    - conan_setup
  artifacts:
    paths:
      - build/
    expire_in: 1 day
  script:
    - mkdir -p build
    - cd build
    - conan install .. --build=missing --profile=linux_x86_64_gcc11_legacy
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - make -j$(nproc) all

runefu:
  image: $CENTOS7_IMAGE
  stage: test
  dependencies:
    - conan_setup
  script:
    - mkdir -p build
    - cd build
    - conan install .. --build=missing --profile=linux_x86_64_gcc11_legacy -s build_type=Debug
    - cmake -DCOV=ON -DCMAKE_BUILD_TYPE=Debug -DGOOGLE_BENCHMARK=ON ..
    - make -j$(nproc) runefu
  artifacts:
    paths:
      - build/
    expire_in: 1 day

coverage:
  image: $ALMALINUX9_IMAGE
  stage: test
  dependencies:
    - conan_setup
  script:
    - mkdir -p build
    - cd build
    - conan install .. --build=missing --profile=linux_x86_64_gcc11 -s build_type=Debug
    - cmake -DCOV=ON -DCMAKE_BUILD_TYPE=Debug -DGOOGLE_BENCHMARK=ON ..
    - make -j$(nproc) runtest
    - make coverage_all
  artifacts:
    paths:
      - build/coverage
    expire_in: 1 week
    reports:
      junit: build/test_results/*.xml
      coverage_report:
        coverage_format: cobertura    
        path: build/coverage/coverage.xml
  coverage: '/^TOTAL\s+\d+\s+\d+\s+(\d+)%/'

publish_tar_job:
  stage: publish
  image: alpine/curl:latest
  dependencies:
    - centos7_gcc11_release
  artifacts: 
    paths:
      - event-formation-unit-centos7.tar.gz
  before_script:
    - curl -fL https://install-cli.jfrog.io | sh
    - jf config add $ESS_ARTIFACTORY_ID --url=$ESS_ARTIFACTORY_URL --user=$ESS_ARTIFACTORY_ECDC_USER --password=$ESS_ARTIFACTORY_ECDC_GENERIC_TOKEN
    - jf config show
  script:
    - mkdir -p archive/event-formation-unit
    - cp -r build/bin archive/event-formation-unit
    - cp -r build/generators archive/event-formation-unit
    - cp -r build/lib archive/event-formation-unit
    - cp -r build/licenses archive/event-formation-unit
    - mkdir archive/event-formation-unit/util
    - cp -r utils/efushell archive/event-formation-unit/util
    - mkdir archive/event-formation-unit/configs
    - mkdir archive/event-formation-unit/data
    - cp build/CONAN_INFO archive/event-formation-unit

    # - # Create file with build information
    - touch archive/event-formation-unit/BUILD_INFO
    - echo 'Repository replace_real_repo_name' >> archive/event-formation-unit/BUILD_INFO
    - echo 'Commit replace_git_commit' >> archive/event-formation-unit/BUILD_INFO
    - echo 'Jenkins build replace_build_id' >> archive/event-formation-unit/BUILD_INFO
    
    - tar czvf event-formation-unit-centos7.tar.gz -C archive event-formation-unit
    - jf rt u --build-name="event-formation-unit-centos7" --build-number=${CI_JOB_ID} event-formation-unit-centos7.tar.gz ecdc-generic-release/${ARTIFACTORY_UPLOAD_PATH}
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        ARTIFACTORY_UPLOAD_PATH: "${CI_PROJECT_NAME}/${CI_DEFAULT_BRANCH}/${CI_PIPELINE_IID}/"
    - if: $CI_COMMIT_TAG
      variables:
        ARTIFACTORY_UPLOAD_PATH: "${CI_PROJECT_NAME}/tags/${CI_COMMIT_TAG}/"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never


publish_docker_job:
  parallel: 
    matrix:
      - INSTRUMENT: "bifrost"
      - INSTRUMENT: "cbm"
      - INSTRUMENT: "cspec"
      - INSTRUMENT: "dream"
      - INSTRUMENT: "estia"
      - INSTRUMENT: "freia"
      - INSTRUMENT: "heimdal"
      - INSTRUMENT: "loki"
      - INSTRUMENT: "magic"
      - INSTRUMENT: "miracles"
      - INSTRUMENT: "nmx"
      - INSTRUMENT: "tbl3he"
      - INSTRUMENT: "timepix3"
      - INSTRUMENT: "trex"

  stage: publish
  image: docker:latest
  services:
    - docker:dind
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/efu-$INSTRUMENT"
  dependencies:
    - almalinux9_gcc11_release
  script:
    - echo "Publishing docker image"
    - |
      docker login \
      -u "$CI_REGISTRY_USER" \
      -p "$CI_REGISTRY_PASSWORD" \
      "$CI_REGISTRY"

    - |
      docker build \
          --build-arg https_proxy="http://172.20.72.11:8888" \
          --build-arg http_proxy="http://172.20.72.11:8888" \
          --build-arg INSTRUMENT_NAME=$INSTRUMENT \
          -t "$IMAGE_NAME" \
          -f .ci/docker/Dockerfile.deploy .
    - docker push "$IMAGE_NAME"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
