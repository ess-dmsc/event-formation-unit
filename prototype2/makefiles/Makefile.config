# Copyright (C) 2016 European Spallation Source ERIC
#

HDF5=
KAFKAINC=/opt/dm_group/usr/include
KAFKALIB=/opt/dm_group/usr/lib

# Verbose
Q=@
ifdef V
Q=
endif

cxx=g++

ifeq ($(_ARCH),Linux)
SHAREDLIB=so
endif

ifeq ($(_ARCH),Darwin)
SHAREDLIB=dylib
endif

include= -I. -I..
warnings = -Werror -Wall -Wpedantic -Wextra -Wmissing-include-dirs

# Experimental RELEASE flag - use  with caution
ifdef RELEASE
optflags = -DNDEBUG
endif

ifdef DEBUG
debugflags = -ggdb
endif

# KAFKA
include+= -I$(KAFKAINC)
kafkalibs= $(KAFKALIB)/librdkafka++.$(SHAREDLIB) $(KAFKALIB)/librdkafka.$(SHAREDLIB)

# Experimental OPTIMIZE flag - use with caution
ifdef OPTIMIZE
optflags += -fprofile-use
endif

#removed from below line: -Ofast -flto  -O3
cxxflags = -std=c++11 $(debugflags) -m64 -march=native $(optflags) $(include) $(warnings)

ifdef TRACE
cxxflags +=-DTRACE -Ofast -flto  -O3
endif


ldflags = -L/usr/local/lib -lpthread -ldl

ifeq ($(_ARCH),Linux)
cxxflags.so = -fPIC
ldflags.so = -Wl,--whole-archive $(library) $(kafkalibs) -Wl,--no-whole-archive -shared
endif

ifeq ($(_ARCH),Darwin)
cxxflags.so = -fPIC
ldflags.so = -Wl,-all_load $(library) $(kafkalibs) -shared
endif

# Enable profiling
ifdef PROF
cxxflags += -pg
ldflags += -pg
ldflags.so += -pg
endif


ifdef GRAYLOG
cxxflags += -DGRAYLOG -I../../graylog-logger/include
ldflags += -L../../graylog-logger/graylog_logger/build -lgraylog_logger
endif

ifdef RELEASE
cxxflags += -DRELEASE
endif

ifdef EXTSCHEMAS
cxxflags += -DFLATBUFFERS
endif

# Enable test coverage and profile guided optimization
ifdef COV
cxxflags += -coverage -fprofile-generate
ldflags += -coverage -fprofile-generate
endif

ldflags_test  = $(ldflags) -lgtest -pthread
cxxflags_test = $(cxxflags) -I/usr/include -fno-exceptions
