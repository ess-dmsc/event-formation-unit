# Copyright (C) 2016 European Spallation Source ERIC
#

testprogs = DetectorTest CSPECDataTest CSPECChanConvTest RingBufferTest
testprogs += CSPECEventTest ParserTest EFUArgsTest CalibrationFileTest EFUStats
testprogs += MultiGridGeometryTest

test: $(testprogs)
	@echo "done building tests"

runtest: test
	$(Q)for test in $(testprogs) ; do ./$$test --gtest_output=xml:$$test.xml ; done

CSPECChanConvTest: test/CSPECChanConvTest.cpp cspec/CSPECChanConv.cpp cspec/CSPECChanConv.h
	@echo building $@
	$(Q)g++ $(cxxflags_test) test/CSPECChanConvTest.cpp cspec/CSPECChanConv.cpp -o $@ $(ldflags_test)

CSPECDataTest:  test/CSPECDataTest.cpp cspec/CSPECData.cpp cspec/CSPECChanConv.cpp cspec/CSPECData.h cspec/CSPECChanConv.h test/CSPECTestData.h
	@echo building $@
	$(Q)g++ $(cxxflags_test) test/CSPECDataTest.cpp cspec/CSPECData.cpp cspec/CSPECChanConv.cpp -o $@ $(ldflags_test)

RingBufferTest: test/RingBufferTest.cpp common/RingBuffer.h
	@echo building $@
	$(Q)g++ $(cxxflags_test) test/RingBufferTest.cpp -o $@ $(ldflags_test)

DetectorTest: test/DetectorTest.cpp common/Detector.h
	@echo building $@
	$(Q)g++ $(cxxflags_test) test/DetectorTest.cpp  -o $@ $(ldflags_test)

CSPECEventTest: test/CSPECEventTest.cpp cspec/CSPECEvent.h
	@echo building $@
	$(Q)g++ $(cxxflags_test) test/CSPECEventTest.cpp  -o $@ $(ldflags_test)

MultiGridGeometryTest: test/MultiGridGeometryTest.cpp common/MultiGridGeometry.h libs/include/TSCTimer.h
	@echo building $@
	$(Q)g++ $(cxxflags_test) test/MultiGridGeometryTest.cpp $(library)  -o $@ $(ldflags_test)

ParserTest: test/ParserTest.cpp test/SyscallWrappers.cpp efu/Parser.cpp common/EFUStats.cpp \
            common/EFUArgs.cpp cspec/CalibrationFile.cpp common/EFUStats.h efu/Parser.h \
            common/EFUArgs.h cspec/CalibrationFile.h
	@echo building $@
	$(Q)g++ -Wl,--wrap=fstat,--wrap=read,--wrap=write,--wrap=open -c  $(cxxflags_test) -std=c++11 -I . \
				-I .. test/SyscallWrappers.cpp test/ParserTest.cpp efu/Parser.cpp common/EFUStats.cpp \
				common/EFUArgs.cpp cspec/CalibrationFile.cpp
	$(Q)g++ -Wl,--wrap=fstat,--wrap=read,--wrap=write,--wrap=open SyscallWrappers.o ParserTest.o Parser.o EFUStats.o\
				CalibrationFile.o EFUArgs.o $(library) -o $@ $(ldflags_test)

CalibrationFileTest: test/CalibrationFileTest.cpp cspec/CalibrationFile.cpp\
      cspec/CalibrationFile.h
	@echo building $@
	$(Q)g++ -Wl,--wrap=fstat,--wrap=read,--wrap=write,--wrap=open -c  $(cxxflags_test) -std=c++11 -I . \
					-I .. test/SyscallWrappers.cpp \
					test/CalibrationFileTest.cpp cspec/CalibrationFile.cpp
	$(Q)g++ -Wl,--wrap=fstat,--wrap=read,--wrap=write,--wrap=open SyscallWrappers.o \
					CalibrationFile.o CalibrationFileTest.o $(library) -o $@ $(ldflags_test)

EFUArgsTest: test/EFUArgsTest.cpp common/EFUArgs.cpp  common/EFUStats.cpp common/EFUArgs.h
				@echo building $@
				$(Q)g++ $(cxxflags_test) test/EFUArgsTest.cpp  common/EFUArgs.cpp common/EFUStats.cpp $(library) -o $@ $(ldflags_test)

EFUStatsTest: test/EFUStatsTest.cpp common/EFUStats.cpp common/EFUStats.h
								@echo building $@
								$(Q)g++ $(cxxflags_test) test/EFUStatsTest.cpp  common/EFUStats.cpp $(library) -o $@ $(ldflags_test)

coverage:
	$(Q)gcov -r -b *.gcda
	$(Q)lcov -c -d . --no-external -o lcov.out
	$(Q)genhtml -o html lcov.out

valgrind: test
	$(Q)rm -f valgrind_error
	$(Q)for test in $(testprogs) ; do valgrind --leak-check=full -v --log-file="$$test.valgrind" ./$$test  || echo error >> valgrind_error; done
